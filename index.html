<!DOCTYPE html>
<html>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="/script/config.js" type="text/javascript"></script>

<head>
    <title>CASI MQTT Websocket</title>
</head>
<body>

    <h1>MQTT Websocket</h1>
    <br />
    First edit this file to define the URL, username and password of your MQTT server.
    <br />
    <form id="connection-info-form">
    <b>Hostname or IP Address:</b> 
    <input id="host" type="text" name="host" value="wss://mqtt.casi.io:8084/mqtt"><br>
    <b>Port:</b>
    <input id="port" type="text" name="port" value="8084"><br>
    <b>Topic:</b>
    <input id="topic" type="text" name="topic" value="#"><br><br>
    <input type="button" onclick="startConnect()" value="Connect">
    <input type="button" onclick="startDisconnect()" value="Disconnect">
    </form>
    <br />
	
    <script type="text/javascript">
    function startConnect() {
    // Generate a random client ID
    clientID = "clientID_" + parseInt(Math.random() * 100);

    // Fetch the hostname/IP address and port number from the form
    host = document.getElementById("host").value;
    port = document.getElementById("port").value;

    // Print output for the user in the messages div
    document.getElementById("messages").innerHTML += '<span>Connecting to: ' + host + ' on port: ' + port + '</span><br/>';
    document.getElementById("messages").innerHTML += '<span>Using the following client value: ' + clientID + '</span><br/>';

    // Initialize new Paho client connection
    const client = mqtt.connect(host, { username, password });

    //client = new Paho.MQTT.Client(host, Number(port), clientID);

    // Set callback handlers
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    client.connect({ 
        onSuccess: onConnect,
        onFailure: document.getElementById("messages").innerHTML += '<span>ERROR: Connection to: ' + host + ' on port: ' + port + ' failed.</span><br/>';
    });
    }
    </script>

	
	

    <div id="main" style="border: 1px solid #ccc; margin 20px; padding: 20px; height: 500px; overflow: auto;">‚è≥ Loading...<br /></div>
    <script type="text/javascript">
      const consoleAdd = function (text) {
        const main = document.getElementById('main');
        main.innerHTML += text + '<br />';
        main.scrollTop = main.scrollHeight;
      }

      // Connection to your MQTT server, using websocket protocol.
      // Note: you have to activate websocket support on Stackhero console, in your service configuration.
      // This example uses the library MQTT.js (https://github.com/mqttjs/MQTT.js)

      // IMPORTANT: you should create a dedicated user with limited rights.
      // Remember that any client using this page can read the source code and get those credentials!
      // Note: on Node-RED, the websocket URL ends with "/mqtt/"
      //const url = 'wss://localhost:8084/mqtt';
      //const username = 'null';
      //const password = 'null';


      consoleAdd('‚è≥ Connecting to MQTT server ' + url + '...');

      // Connecting to MQTT server using websockets
      const client = mqtt.connect(url, { username, password });

      client.on('error', function (error) {
        consoleAdd('üö® Error: ' + error);
      });

      client.on('close', function () {
        consoleAdd('üîå Connection has been closed');
      });

      client.on('reconnect', function () {
        consoleAdd('‚è≥ Reconnecting...');
      });



      // On MQTT connection, we subscribe to the "presence" topic and send "Hello MQTT" to it.
      client.on('connect', function () {
        consoleAdd('‚úÖ Connected!');

        const topic = 'presence';
        const topic2 = 'room/light';
	const message = 'Hello MQTT';

        // Subscribe to topic "presence"
        client.subscribe(topic2, function (err, res) {
          if (err) {
            consoleAdd('üö® Error when subscribing to topic ' + topic2 + ': ' + err);
            return;
          }

          // Sending message "Hello MQTT" to topic "presence"
          consoleAdd('‚úÖ Sending message "' + message + '" to topic "' + topic + '"');
          client.publish(
            topic,
            message,
            { qos: 2 },
            function(err) {
              if (err) {
                consoleAdd('üö® Error when publishing to topic ' + topic + ': ' + err);
              }
            }
          );
        })
      });

      // Show messages received on every topic
      client.on('message', function (topic2, message) {
        consoleAdd('‚úÖ Message received from MQTT server on topic "' + topic2 + '": ' + message);
      });
    </script>
  </body>
</html>
